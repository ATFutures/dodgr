---
title: "dodgr benchmark"
author: "Andreas Petutschnig"
date: "`r Sys.Date()`"
output: 
    html_document:
        toc: true
        toc_float: true
        number_sections: true
        theme: flatly
vignette: >
  %\VignetteIndexEntry{benchmark}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE}
devtools::load_all (".", export_all = FALSE)
```

# Introduction

This vignette contains runtime comparisons for a number of routing
operations between random vertices using distance calculation functions from the
`dodgr` and [`igraph`](https://cran.r-project.org/package=igraph) packages. The
experiments are run using the `compare_heaps()` function, which successively
calls functions `igraph::distances()` and then `dodgr_dists()` with all
implemented options for the `heap` parameter and measures their respecive
runtimes.

The graph data on which the tests are performed are taken from the
[`igraphdata`](https://cran.r-project.org/package=igraphdata) package.

# Get Graph Data

To be able to run `compare_heaps()`, we need to create `data.frame` objects from
the `igraphdata` data. As we need at least columns for each graph edges' origin,
destination and weight, not all `igraphdata` are fit for our purposes, because
they lack a weight column. In these cases, all their edge weights are assumed to
be 1 so they can be brought into a valid format.

The following code compiles all `igraph` objects into a list of usable
`data.frame` objects.

```{r}
datasets <- data (package = "igraphdata")
datasets <- datasets$results [, "Item"]

all_graphs <- list ()
gr_el <- 1

for (i in seq_along (datasets))
{
    dat <- datasets [i]
    data (package = "igraphdata", list = dat)
    dat_graph <- get (dat)
    if (class (dat_graph) == "igraph")
        dat_graph <- list (dat_graph)
    for (j in seq_along (dat_graph))
    {
        graph <- dat_graph [[j]]
        graph <- igraph::get.data.frame (graph)
        from_id <- graph$from
        to_id <- graph$to
        if ("weight" %in% names (graph))
        {
            d <- graph$weight
            graph_out <- data.frame (from_id, to_id, d)
            all_graphs [[gr_el]] <- graph_out
            gr_el <- gr_el + 1
        } else
        {
            graph [c ("from", "to")] <- NULL
            edge_cols <- which (sapply (graph, class) == "numeric")
            len <- length (edge_cols)
            if (len > 0)
            {
                for (k in seq_len (len))
                {
                    d <- graph [, k]
                    graph_out <- data.frame (from_id, to_id, d)
                    all_graphs [[gr_el]] <- graph_out
                    gr_el <- gr_el + 1
                }
            } else
            {
                d <- rep (1, length (from_id))
                graph_out <- data.frame (from_id, to_id, d)
                all_graphs [[gr_el]] <- graph_out
                gr_el <- gr_el + 1
            }
        }
    }
}
```

Now, `compare_heaps()` can be run for all graphs.

```{r}
#benchmarks <- lapply (all_graphs, compare_heaps)
benchmarks <- readRDS ("benchmark_data.rds")
r1 <- vector (mode = "numeric", length = length (benchmarks))
r2 <- vector (mode = "numeric", length = length (benchmarks))
r3 <- vector (mode = "numeric", length = length (benchmarks))
r4 <- vector (mode = "numeric", length = length (benchmarks))
r5 <- vector (mode = "numeric", length = length (benchmarks))
r6 <- vector (mode = "numeric", length = length (benchmarks))

for (i in seq_along (benchmarks))
{
    bm <- benchmarks [[i]]
    r1 [i] <- bm$elapsed [1]
    r2 [i] <- bm$elapsed [2]
    r3 [i] <- bm$elapsed [3]
    r4 [i] <- bm$elapsed [4]
    r5 [i] <- bm$elapsed [5]
    r6 [i] <- bm$elapsed [6]
}

max_y <- max (r1, r2, r3, r4, r5, r6)
cl <- c ("black", "blue", "green", "red", "Plum", "Orange")
```

```{r fig.width=14, fig.height=10}
plot (r1, type = "l", ylim = c (1e-6, max_y), log = "y")
lines (r2, col = cl [2])
lines (r3, col = cl [3])
lines (r4, col = cl [4])
lines (r5, col = cl [5])
lines (r6, col = cl [6])
legend (10, 5e-4, bm$test, lty=c(1,1), lwd=c(2.5,2.5), col = cl)
```
